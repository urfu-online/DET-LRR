{% extends "base.html" %}
{% load static bootstrap_icons %}
{% load user_tags %}
{% block content %}
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb px-3 pb-0">
      <li class="breadcrumb-item"><a href="/">{% md_icon "bank-outline" %}</a></li>
      <li class="breadcrumb-item"><a href="/">Каталог ЭОР</a></li>
      <li class="breadcrumb-item active" aria-current="page">Паспорт ЭОР: {{ object.title }}</li>
    </ol>
  </nav>
  <header class="pb-4 px-2">
    {% if request.user|has_owner_resource:object or request.user.is_superuser %}
      <a class="btn btn-primary float-right" href="{{ object.get_update_url }}"><i class="fas fa-edit"></i>
        Редактировать</a>
    {% endif %}
    <h1 class="mb-0">{{ object.title }}
      {% include "includes/subtitle.html" with subtitle="Паспорт электронного образовательного ресурса" %}
    </h1>

  </header>
  {% if request.user.is_authenticated %}
    <div class="row">
      <div class="col-12 col-md-6 col-lg-7 col-xl-8 p-2">
        <div class="card border-secondary h-100 shadow-2">
          <div class="card-body">

            <h5 class="card-subtitle mb-2 text-muted"><i class="fas fa-newspaper"></i> Описание</h5>
            {% if object.description %}
              <p>{{ object.description }}</p>
            {% else %}
              {% include "includes/empty_alert.html" with msg="Описание отсутвует" %}
            {% endif %}
            <hr>

            <h5 class="card-subtitle mb-2 text-muted"><i class="fas fa-tags"></i> Ключевые слова</h5>
            {% if object.keywords %}
              <p>{{ object.keywords }}</p>
            {% else %}
              {% include "includes/empty_alert.html" with msg="Ключевые слова отсутствуют" %}
            {% endif %}
            <hr>
            <h5 class="card-subtitle mb-2 text-muted"><i class="fas fa-award"></i> Компетенции / Результаты обучения
            </h5>
            <h5 class="card-title"></h5>
            {% if object.result_edu.all %}
              <ul class="list-unstyled">
                {% for object in object.result_edu.all %}
                  {% include "repository/result_edu.html"  with object=object %}
                {% endfor %}
              </ul>
            {% else %}
              {% include "includes/empty_alert.html" with msg="Компетенции / Результаты обучения отсутствуют" %}
            {% endif %}
            <hr/>

            <h5 class="card-subtitle mb-2 text-muted"><i class="fas fa-star"></i> Статусы ЭОР</h5>
            {% if expertise %}
              <table class="table table-striped table-bordered">
                <thead>
                <tr>
                  {#                <th>Наименование</th>#}
                  <th>Статус</th>
                  <th>Дата</th>
                </tr>
                </thead>
                {#                {% if request.user|has_owner_resource:object %}#}
                {% for item in expertise %}
                  <tbody>
                  <tr>
                    {#                  <td>{{ item.quality_category }} {{ item.interactive_category }} {{ item.subjects }} {{ item.direction }}</td>#}
                    {#                      <td>{{ item.get_status_display }}</td>#}
                    <td>{{ item.status_text }}</td>
                    <td>{{ item.date_end }}</td>
                  </tr>
                  </tbody>
                {% endfor %}
                {#                {% endif %}#}
                {% for i in temporary_status %}
                  <tbody>
                  <tr>
                    <td>{{ i.name }}</td>
                    <td>{{ i.date }}</td>
                  </tr>
                  </tbody>
                {% endfor %}
              </table>
            {% else %}
              <div class="d-flow-root">
                {% include "includes/empty_alert.html" with msg="Статусы отсутствуют" %}
                {% if request.user|has_owner_resource:object %}
                  <a href="{{ object.get_create_request_url }}" class="btn btn-primary float-right mb-3"><i class="fas fa-share-square"></i> Подать заявку на экспертизу</a>
                {% else %}
                  {% if request.user|has_owner_resource:object %}
                    <a href="{{ object.get_create_request_url }}" class="btn btn-primary float-right mb-3"><i class="fas fa-share-square"></i> Подать заявку на экспертизу</a>
                  {% endif %}
                {% endif %}
              </div>
            {% endif %}


            <hr/>
            <h5 class="card-subtitle mb-2 text-muted"><i class="fas fa-layer-group"></i> Компоненты ЭОР</h5>
            {% if source %}
              {{ source.URL }}
              <table class="table table-striped table-bordered">
                <thead>
                <tr>
                  <th>Наименование компонента</th>
                  <th>URL компонента</th>
                  <th>Тип компонента</th>
                </tr>
                </thead>
                <tbody>
                {% for item_source in source %}
                  <tr>
                    <td style="word-break: break-all;">{% if item_source.get_link_name %}{{ item_source.get_link_name }}{% else %}{% include 'includes/empty_icon.html' %}{% endif %}</td>
                    <td><a style="word-break: break-all;" href="{{ item_source.URL }}">{{ item_source.URL }}</a></td>
                    <td>{{ item_source.get_type_display }}</td>
                  </tr>
                {% endfor %}
                </tbody>
              </table>
            {% else %}
              {% include "includes/empty_alert.html" with msg="Компоненты отсутствуют" %}
            {% endif %}
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-lg-5 col-xl-4 p-2">
        <a href="{{ object.get_url }}" class="btn btn-block btn-primary mb-3"><i class="fas fa-user-graduate"></i>
          Перейти</a>
        {% if request.user|has_group:"teacher" %}
          <div class="btn btn-block btn-primary mb-3" style="cursor: pointer;" data-id="{{ object.id }}"
               data-type="resource" data-action="bookmark"
               title="Избранное">
            {% if object.bookmarkdigitalresource_set.all|user_in:user %}
              В избранном
            {% else %}
              Добавить в избранное
            {% endif %}
            <span class="{% if object.bookmarkdigitalresource_set.all|user_in:user %}fa fa-star fa-lg{% else %}far fa-star fa-lg{% endif %}"></span>
          </div>
        {% endif %}
        <div class="card border-secondary shadow-2 mb-3">
          <div class="card-body">
            <h5 class="card-subtitle mb-2 text-muted">Авторы:</h5>
            <p class="card-title">{% for obj in object.authors.all %}
              {% include "repository/author.html" with object=obj %}
            {% endfor %}</p>
          </div>
        </div>
        <div class="card border-secondary shadow-2">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Владелец:</h6>
            {% if object.owner is None %}
              <h5 class="card-title">Владелец отсутсвует</h5>
            {% else %}
              <h5 class="card-title"> {{ object.owner }}</h5>
            {% endif %}
            <hr>
            <h6 class="card-subtitle mb-2 text-muted">Тип ресурса:</h6>
            <h5 class="card-title"> {{ object.get_type_display }}</h5>
            <hr>
            <h6 class="card-subtitle mb-2 text-muted">Платформа:</h6>
            <h5 class="card-title"> {{ object.platform }}</h5>
            <hr>
            <h6 class="card-subtitle mb-2 text-muted">Язык ресурса:</h6>
            <h5 class="card-title"> {{ object.language.title }}</h5>
            <hr>
            <h6 class="card-subtitle mb-2 text-muted">Правообладатель:</h6>
            <h5 class="card-title"> {{ object.copyright_holder }}</h5>
            <hr>
            <h6 class="card-subtitle mb-2 text-muted">Источник данных:</h6>
            <h5 class="card-title"> {{ object.get_source_data_display }}</h5>
            <hr>
            <h6 class="card-subtitle mb-2 text-muted">Дата создания паспорта:</h6>
            <h5 class="card-title"> {{ object.created }}</h5>
            <hr>
            <h6 class="card-subtitle mb-2 text-muted">Направление/ОП:</h6>
            <h5 class="card-title">
              {% for tag in object.edu_programs_tags.all %}
                {% include "repository/tag.html" with tag=tag %}
              {% endfor %}
            </h5>
            <hr>
            <h6 class="card-subtitle mb-2 text-muted">Дисциплина:</h6>
            <h5 class="card-title">
              {% for tag in object.subjects_tags.all %}
                {% include "repository/tag.html" with tag=tag %}
              {% endfor %}
            </h5>


          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {% csrf_token %}
  <script>
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    function to_bookmarks() {
      let current = $(this);
      let type = current.data('type');
      let pk = current.data('id');
      let action = current.data('action');

      $.ajax({
        url: "/repository/" + type + "/" + pk + "/" + action + "/",
        type: 'POST',
        data: {'obj': pk},
        headers: {'X-CSRFToken': csrftoken},

        success: function (json) {
          current.find("[data-count='" + action + "']").text(json.count);
          location.reload();
        }
      });

      return false;
    }

    // Подключение обработчика
    $(function () {
      $('[data-action="bookmark"]').click(to_bookmarks);
    });
  </script>


{% endblock %}
