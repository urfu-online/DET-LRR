{% extends "base.html" %}
{% load static user_tags %}

{% block content %}
  <link href="{% static 'gridstack/dist/gridstack.min.css' %}" rel="stylesheet"/>
  <link href="{% static 'gridstack/dist/gridstack-extra.css' %}" rel="stylesheet"/>
  <script src="{% static 'gridstack/dist/gridstack-h5.js' %}"></script>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb px-3 pb-0">
      <li class="breadcrumb-item"><a href="/"><i class="fas fa-university fa-lg"></i></a></li>
      <li class="breadcrumb-item"><a href="{% url 'complexes:complexes_DigitalComplex_list' %}">Список ЭУМК</a></li>
      <li class="breadcrumb-item"><a
              href="{% url 'complexes:complexes_DigitalComplex_detail' pk=dig_complex.pk %}">{{ dig_complex }}</a></li>
      <li class="breadcrumb-item active" aria-current="page">Редактирование структурно-тематического плана
        ЭУМК {{ dig_complex }}</li>
    </ol>
  </nav>

  <header><h3>Редактирование структурно-тематического плана ЭУМК по
    {% for subject in dig_complex.subjects.all %}{{ subject }}{% endfor %} образовательной программы
    {% for subject in dig_complex.directions.all %}{{ direction }}{% endfor %}</h3></header>

  {% if request.user.is_authenticated %}
    {#    <div class="row p-2">#}
    {#      <div class="col-12 col-lg-12 col-xl-10 p-2">#}
    {#        <div class="card border-secondary shadow-2 h-100">#}
    {#          <div class="card-header"><h5>Редактирование структурно-тематического плана ЭУМК по#}
    {#            {% for subject in dig_complex.subjects.all %}{{ subject }}{% endfor %} образовательной программы#}
    {#            {% for subject in dig_complex.directions.all %}{{ direction }}{% endfor %}</h5></div>#}
    {#          <div class="card-body">#}
    {##}
    {#            <table class="table table-striped table-bordered col-12 col-lg-12 col-xl-10">#}
    {#              <thead>#}
    {#              <th>Тема / раздел</th>#}
    {#              <th>Теория</th>#}
    {#              <th>Практика</th>#}
    {#              </tr>#}
    {#              </thead>#}
    {#              <tbody>#}
    {#              {% for object in object_list %}#}
    {#                <tr>#}
    {#                <td>{{ object.theme_name }}</td>#}
    {#                <td>{% if object.include_theory %}Да{% else %}Нет{% endif %}</td>#}
    {#                <td>{% if object.include_practice %}Да{% else %}Нет{% endif %}</td>#}
    {#                <td><a class="btn btn-outline-primary text-nowrap"#}
    {#                       href="{% url 'complexes:complexes_AssignmentAcademicGroup_update' pk=object.pk %}">#}
    {#                  <i class="fas fa-edit"></i> Редактировать</a>#}
    {#                </td>#}
    {#                <td><a class="btn btn-primary"#}
    {#                       href="{% url 'complexes:complexes_AssignmentAcademicGroup_delete' pk=object.pk %}">#}
    {#                  <i class="fas fa-trash-alt"></i></a></td>#}
    {#              {% empty %}#}
    {#                Ячейки цифрового комплекса ЭУМК отсутсвуют#}
    {#              {% endfor %}#}
    {#              </tbody>#}
    {#            </table>#}
    {#          </div>#}
    {#        </div>#}
    {#      </div>#}
    {#    </div>#}
  {% endif %}
  <h1>Serialization demo</h1>
  <a onClick="addGrid1()" class="btn btn-primary" href="#">Add Grid 1</a>
  <a onClick="addGrid2()" class="btn btn-primary" href="#">Add Grid 2</a>
  <a onClick="addGrid3()" class="btn btn-primary" href="#">Add Grid 2</a>
  <a onClick="addNested('.nested1')" class="btn btn-primary" href="#">Add Nested 1</a>
  <a onClick="addNested('.nested2')" class="btn btn-primary" href="#">Add Nested 2</a>
  <a onClick="saveGrid()" class="btn btn-primary" href="#">Save</a>
  <a onClick="loadGrid()" class="btn btn-primary" href="#">Load</a>
  <a onClick="saveFullGrid()" class="btn btn-primary" href="#">Save Full</a>
  <a onClick="loadFullGrid()" class="btn btn-primary" href="#">Load Full</a>
  <a onClick="clearGrid()" class="btn btn-primary" href="#">Clear</a>
  <br/><br/>
  <div class="container-fluid">
{#      <div class="" id="kek1"></div>#}
{#      <div class="" id="kek2"></div>#}
{#      <div class="" id="kek3"></div>#}
      <div class="row" style="margin-top: 20px; padding: 0; !important;">
        <div class="col-md-4">
          <div class="grid-stack" id="kek1"></div>
        </div>
        <div class="col-md-4">
          <div class="grid-stack" id="kek2"></div>
        </div>
        <div class="col-md-4">
          <div class="grid-stack" id="kek3"></div>
        </div>
      </div>
  </div>
  <div id="gridMain"></div>
  <hr/>
  <style>
  </style>

  <script type="text/javascript">
    let count = 0
    let subOptions = {
      cellHeight: 30,
      column: 1, // make sure to include gridstack-extra.min.css
      itemClass: 'sub', // style sub items differently and use to prevent dragging in/out
      acceptWidgets: '.grid-stack-item.sub', // only pink sub items can be inserted, otherwise grid-items causes all sort of issues
      minWidth: 300, // min to go 1 column mode
      margin: 1
    };
    let json = {
      cellHeight: 70,
      minRow: 3,
      children: [],
      column: 1,
    };
    let grid = GridStack.addGrid(document.querySelector('#kek1'), json);
    let grid2 = GridStack.addGrid(document.querySelector('#kek2'), json);
    let grid3 = GridStack.addGrid(document.querySelector('#kek3'), json);


    grid.on('added removed change', function (e, items) {
      let str = '';
      items.forEach(function (item) {
        str += ' (x,y) (w,h)=' + item.x + ',' + item.y + ";" + item.w + "," + item.h;
      });
      console.log(e.type + ' ' + items.length + ' items:' + str);
    });

    let serializedData = [
      {x: 0, y: 0, w: 2, h: 2, id: '0'},
      {
        x: 1,
        y: 0,
        w: 1,
        h: 1,
        id: '1',
        content: "<button class='btn btn-outline-primary text-nowrap' onclick=\"alert('clicked!')\">Редактировать</button>"
      },
    ];
    serializedData.forEach((n, i) =>
            n.content = `<button class="btn btn-primary" onClick="grid.removeWidget(this.parentNode.parentNode)"><i class="fas fa-trash-alt"></i></button> ${n.content ? n.content : ''}`);
    let serializedFull;

    // 2.x method - just saving list of widgets with content (default)
    loadGrid = function () {
      grid.load(json, true); // update things
    }

    // 2.x method
    saveGrid = function () {
      delete json;
      json = grid.save();
      document.querySelector('#saved-data').value = JSON.stringify(json, null, '  ');
    }

    // 3.1 full method saving the grid options + children (which is recursive for nested grids)
    saveFullGrid = function () {
      serializedFull = grid.save(true, true);
      serializedData = serializedFull.children;
      document.querySelector('#saved-data').value = JSON.stringify(serializedFull, null, '  ');
    }

    // 3.1 full method to reload from scratch - delete the grid and add it back from JSON
    loadFullGrid = function () {
      if (!json) return;
      grid.destroy(true); // nuke everything
      grid = GridStack.addGrid(document.querySelector('#gridCont'), json)
    }

    addWidget = function () {
      //let n = {
      //x: Math.round(12 * Math.random()),
      //y: Math.round(5 * Math.random()),
      //w: Math.round(1 + 3 * Math.random()),
      //h: Math.round(1 + 3 * Math.random())
      //};
      let n = {
        x: 0,
        y: 0,
        w: 1,
        h: 1,
        text: "Kek"
      }
      n.content = `<button class="btn btn-primary" onClick="grid.removeWidget(this.parentNode.parentNode)"><i class="fas fa-trash-alt"></i></button>` + (n.text ? n.text : '');
      grid.addWidget(n);
    };

    clearGrid = function () {
      grid.removeAll();
    }

    function addGrid1() {
      grid.addWidget(
              {
                x: 0,
                y: 0,
                w: 3,
                h: 3,
                subGrid: {
                  class: 'nested1',
                  ...subOptions
                },
              }
      );
    }

    function addGrid2() {
      grid2.addWidget(
              {
                x: 0,
                y: 0,
                w: 3,
                h: 3,
                subGrid: {
                  class: 'nested2',
                  ...subOptions
                },
              }
      );
    }
        function addGrid3() {
      grid3.addWidget(
              {
                x: 0,
                y: 0,
                w: 3,
                h: 3,
                subGrid: {
                  class: 'nested2',
                  ...subOptions
                },
              }
      );
    }

    addNested = function (selector) {
      let subGrid = document.querySelector(selector).gridstack;
      let node = {
        x: 0,
        y: 0,
        w: 1,
        h: 2,
        content: "dfdf"
      };
      subGrid.addWidget(node);
      return false;
    };

    removeGrid = function (id) {
      document.getElementById(id).remove();
    }

    loadGrid();
  </script>

{% endblock %}
